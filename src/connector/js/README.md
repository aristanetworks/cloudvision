# CloudVision Connector

The CloudVision Connector is a simple JavaScript module using WebSockets that enables you to transmit data over an open connection with the CloudVision API server. The CloudVision Connector supports subscribing to data, which lets clients receive streaming updates as data changes in real-time.

## Installation

with yarn:

```bash
yarn add cloudvision-connector
```

or npm:

```bash
npm install --save cloudvision-connector
```

## Usage

### [Getting Started](readme-parts/GettingStarted.md)

Quick introduction into to how to connect to the API server

### [Getting Data](readme-parts/GettingData.md)

More in depth information on how to query different data.

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [Connector](#connector)
    -   [closeSubscriptions](#closesubscriptions)
        -   [Parameters](#parameters)
        -   [Examples](#examples)
    -   [getAndSubscribe](#getandsubscribe)
        -   [Parameters](#parameters-1)
        -   [Examples](#examples-1)
    -   [getApps](#getapps)
        -   [Parameters](#parameters-2)
    -   [getDatasets](#getdatasets)
        -   [Parameters](#parameters-3)
    -   [getDevices](#getdevices)
        -   [Parameters](#parameters-4)
    -   [getWithOptions](#getwithoptions)
        -   [Parameters](#parameters-5)
        -   [Examples](#examples-2)
    -   [subscribe](#subscribe)
        -   [Parameters](#parameters-6)
        -   [Examples](#examples-3)
    -   [writeSync](#writesync)
        -   [Parameters](#parameters-7)
-   [PublishRequest](#publishrequest)
    -   [Properties](#properties)

### Connector

**Extends WRPC**

The Connector uses WebSockets to enable transmission of data over an
open connection with the CloudVision API server.
It supports subscriptions, which allows clients to receive streaming
updates as data changes in real-time.

#### closeSubscriptions

Close multiple subscriptions in one `close` call. The subscription
identifier return in the `subscribe` call along with the close function
can be passed in here to close the subscription together with others.

##### Parameters

-   `subscriptions` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;SubscriptionIdentifier>** 
-   `callback` **NotifCallback** 

##### Examples

```javascript
const query = [{
  dataset: {
    type: 'app',
    name: 'analytics'
  },
  paths: [{
    type: 'EXACT',
    path: '/events/activeEvents',
  }],
}];
const handleResponse = (err, res) => {...};

// Send the request
const subscriptionCloseFn = connector.subscribe(query, handleResponse);

// Close the subscription via `closeSubscriptions`
const closeSubscriptions([subscriptionCloseFn.identifier]);
```

#### getAndSubscribe

Returns all notifications that match the given query and options, in
addition to subscribing to updates. This will return notifications as
new updates to the data requested come in.

A `getAndSubscribe` is done in such a way that not notifications are lost.
Before doing a `get`, a `subscribe` is initiated and we wait for an active
status message to be returned before initiating a `get`.

##### Parameters

-   `query` **Query** 
-   `callback` **NotifCallback** 
-   `options` **Options**  (optional, default `{}`)

##### Examples

```javascript
const query = [{
  dataset: {
    type: 'app',
    name: 'analytics'
  },
  paths: [{
    type: 'EXACT',
    path: '/events/activeEvents',
  }],
}];
const options = {
  start: 1504113817725,
  end: 1504113917725,
};
const handleResponse = (err, res) => {...};

// open the stream
const closeSubscription = connector.getAndSubscribe(
  query, handleResponse, options);

closeSubscription(); // close the stream when finished
```

Returns **SubscriptionCloseFunction** 

#### getApps

Returns a list of apps (datasets with type == 'app').

##### Parameters

-   `callback` **NotifCallback** 

Returns **void** 

#### getDatasets

Returns a list of data sets. This will return data sets of type 'device',
as well as type 'app'.

##### Parameters

-   `callback` **NotifCallback** 

Returns **void** 

#### getDevices

Returns a list of devices (datasets with type == 'device').

##### Parameters

-   `callback` **NotifCallback** 

Returns **void** 

#### getWithOptions

Returns all notifications that match the given query and options.

##### Parameters

-   `query` **(Query | GetDatasetsCommand)** 
-   `callback` **NotifCallback** 
-   `options` **Options**  (optional, default `{}`)

##### Examples

```javascript
const query = [{
  dataset: {
    type: 'app',
    name: 'analytics'
  },
  paths: [{
    type: 'EXACT',
    path: '/events/activeEvents',
  }],
}];
const options = {
  start: 1504113817725,
  end: 1504113917725,
};
const handleResponse = (err, res) => {...};

// Send the request
connector.getWithOptions(query, handleResponse, options);
```

Returns **void** 

#### subscribe

Creates a subscription to the given query, which will return
notifications as they happen. Note that this will not return any
historical data. The first update that is sent will be when the state
of the data in the query changes.

Subscriptions can have `REGEXP` (not just `EXACT`, as is the case for
`gets`) as their path type, which allows subscribing to a path using any
syntax supported by regular expressions.

##### Parameters

-   `query` **Query** 
-   `callback` **NotifCallback** 

##### Examples

```javascript
const query = [{
  dataset: {
    type: 'app',
    name: 'analytics'
  },
  paths: [{
    type: 'EXACT',
    path: '/events/activeEvents',
  }],
}];
const handleResponse = (err, res) => {...};

// Send the request
const subscriptionCloseFn = connector.subscribe(query, handleResponse);
```

Returns **SubscriptionCloseFunction** 

#### writeSync

Write data to the CloudVision API server, where the update is a
series of notifications of a certain data set.

The writeSync operation is synchronous.

##### Parameters

-   `publishRequest` **[PublishRequest](#publishrequest)** 
-   `callback` **PublishCallback** 

### PublishRequest

The request type of a publish command.

Type: {dataset: DatasetObject, notifications: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;CloudVisionNotification>}

#### Properties

-   `dataset` **DatasetObject** 
-   `notifications` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;CloudVisionNotification>** 

## Try it out

To try out the CloudVision Connector in your browser, simply run

```shell
yarn install
yarn run build:try
```

Then open **index.html** in your browser. In the developer console
CloudVision Connector will be available as **window.CloudVisionConnector**.

### Examples

Create the connector: `conn = new window.CloudVisionConnector()`
Connect to an API server: `conn.run('ws://example.cloudvision.api-server/api/v2/wrpc/')`
Run a query: `conn.getWithOptions(window.CloudVisionConnector.DEVICES_DATASET_ID
, (err, res) => console.log(err, res))`

## Contributing

Contributing pull requests are welcomed for this repository. Please note that all contributions require 100% code test cases and 100% code coverage, otherwise the pull request will be rejected.

## License

The CloudVision Connector is [MIT licensed](LICENSE).
